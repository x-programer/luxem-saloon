rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // 1. PUBLIC SERVICES (Global)
    // Allows anyone to read services.
    // Allows vendors to create/update/delete their OWN services.
    match /services/{serviceId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    // 2. USERS COLLECTION
    match /users/{userId} {
      allow read: if true; // Profile is public
      allow write: if isSignedIn() && isOwner(userId); // Only vendor edits profile

      // 3. APPOINTMENTS SUBCOLLECTION
      match /appointments/{appointmentId} {
         // Vendor: Full Access (Read, Write, Update, Delete)
         allow read, write: if isSignedIn() && isOwner(userId);
         
         // Customer: Can BOOK (create) an appointment
         // SECURE: Enforce that the 'customerId' in the data matches the logged-in user.
         allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
         
         // Customer: Can READ their own appointments
         allow read: if isSignedIn() && resource.data.customerId == request.auth.uid;
      }

      // Generic rule for other subcollections (like staff, gallery)
      match /{subcollection}/{document=**} {
         allow read: if true;
         allow write: if isSignedIn() && isOwner(userId);
      }
    }

    // 4. REVIEWS
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
      allow delete: if isSignedIn() && (
        resource.data.customerId == request.auth.uid || 
        resource.data.vendorId == request.auth.uid
      );
    }
  }
}
