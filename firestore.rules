rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- üõ°Ô∏è HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    // Convert email to lower case to ensure case-insensitive match
    function isSuperAdmin() {
      return request.auth.token.email.lower() == "ringtoneboy1530@gmail.com";
    }

    // --- 1. üìÖ ROOT BOOKINGS (Optional) ---
    match /bookings/{bookingId} {
      allow read, list: if isSignedIn() && (
        resource.data.vendorId == request.auth.uid || 
        resource.data.customerId == request.auth.uid || 
        isSuperAdmin()
      );
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        resource.data.vendorId == request.auth.uid || 
        resource.data.customerId == request.auth.uid || 
        isSuperAdmin()
      );
      allow delete: if isSuperAdmin();
    }

    // --- 2. üë• USERS & VENDORS ---
    match /users/{userId} {
      // Public read required for profiles
      allow read: if true; 
      // Write only by owner or admin
      allow write: if isSignedIn() && (isOwner(userId) || isSuperAdmin()); 

      // ‚úÖ APPOINTMENTS (Subcollection)
      match /appointments/{appointmentId} {
         // Allow owner (vendor) to read/write their own appointments
         allow read: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
         allow write: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
         
         // Allow customers to create bookings (status=pending)
         allow create: if isSignedIn() 
                       && request.resource.data.customerId == request.auth.uid;
         
         // Allow customers to cancel their own bookings
         allow update: if isSignedIn() 
                       && resource.data.customerId == request.auth.uid;
      }

      // üîî NOTIFICATIONS
      match /notifications/{notificationId} {
         allow read, write: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      }

      // üõ†Ô∏è OTHER SUBCOLLECTIONS
      match /staff/{staffId} {
         allow read: if true;
         allow write: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      }
      
      match /gallery/{imageId} {
         allow read: if true;
         allow write: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      }

      match /products/{productId} {
         allow read: if true;
         allow write: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      }

      match /offers/{offerId} {
         allow read: if true;
         allow write: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      }
    }

    // --- 3. üõ†Ô∏è PUBLIC SERVICES ---
    match /services/{serviceId} {
      allow read: if true;
      allow create, update, delete: if isSignedIn() && (
        request.resource.data.uid == request.auth.uid || 
        resource.data.uid == request.auth.uid ||
        isSuperAdmin()
      );
    }

    // --- 4. ‚≠ê REVIEWS ---
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
      allow delete: if isSignedIn() && (
        resource.data.customerId == request.auth.uid || 
        resource.data.vendorId == request.auth.uid ||
        isSuperAdmin()
      );
    }
  }
}
